{% extends "base-sidebar.html" %}

{% block title %}
  AIS - {{ chat.title }} Key Questions
{% endblock title %}

{% block content %}
  <!-- All styles moved to main.css Chat Input, Pagination, and Progress Components sections -->
  {% load static %}
  <div id="questions-container" class="centered-container flex-grow-1 d-flex flex-column">
    <nav aria-label="Page navigation example">
      <ul class="pagination">
        {% comment %} <li class="page-item">
          <a class="page-link" href="#" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li> {% endcomment %}
        {% for key_question in chat.key_questions %}
          <li class="page-item"><a class="page-link {% if forloop.counter0 == question_id %}active{% endif %}" href="{% url "key-questions" chat_id=chat.id question_id=forloop.counter0 %}">{{ forloop.counter }}</a></li>
        {% endfor %}
        {% comment %} <li class="page-item">
          <a class="page-link" href="#" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li> {% endcomment %}
      </ul>
    </nav>
    <h3 class="whiteTextOverride">{{ question.title }}</h3>
    <div id="chat-scroll" class="d-flex flex-column-reverse flex-grow-1 overflow-y-auto overflow-x-hidden pe-0">
      <div class="row flex-column-reverse">
        <div id="chat-messages">
          <div class="col bot-text-container">
            <div class="card bot-text-bubble">
              <div class="card-body">
                  <div class="ai_messages"> 
                  <p class="card-text" id="ai_message">{{ question.content }}</p>
                  <div class="progress" role="progressbar" aria-label="Example 20px high" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                    <div id="timer-bar" class="progress-bar"></div>
                  </div>
                  <h5 id="timer-text">{{ question.duration }}s</h5>
                  {% comment %} <button class="button-chat-send btn btn-primary ms-2" id="text2speech_button" onclick="textToSpeech(this)">Speak</button> {% endcomment %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="inputCard" class="input-card card mb-3 mt-3">
      <div class="card-body">
        <div class="d-flex">
          <textarea id="user-input" class="chat-input flex-grow-1 border-0 p-2" placeholder="Enter text here..."></textarea>
          {% comment %} <button class="button-chat-send btn btn-primary ms-2" id = "speech-text" onclick="speechToText()">Speak</button> {% endcomment %}
          {% comment %} <button class="button-chat-send btn btn-primary ms-2" type="button" onclick="location.reload()">Retry</button> {% endcomment %}
          <button class="button-chat-send btn btn-primary ms-2" type="button" onclick="sendMessage()">Send</button>
        </div>
        <!-- Connection notification and status row -->
        <div class="d-flex justify-content-between align-items-center mt-2">
          <!-- Connection Dropped Notification (Inline) -->
          <div id="connectionDroppedNotification" class="connection-notification" style="display: none;">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  <i class="bi bi-wifi-off me-2"></i>
                  <strong>Connection Lost</strong>
                </div>
                <p class="mb-2 small">Disconnected at <span id="connectionDropTime"></span>. Your answer will be saved locally.</p>
                <button type="button" class="btn btn-primary btn-sm" onclick="retryConnection()">Retry</button>
              </div>
              <button type="button" class="btn-close ms-2" onclick="dismissConnectionNotification()" aria-label="Close"></button>
            </div>
          </div>
          <!-- Connection Status Indicator -->
          <div id="connection-status" class="connection-status">
            <i class="bi bi-wifi connection-status-icon"></i>
            <span class="connection-status-text">Saved by server</span>
          </div>
        </div>
      </div>
    </div>
    {% comment %} <button class="button-chat-send btn btn-primary mb-2 d-none" type="button" onclick="location.reload()">Retry</button> {% endcomment %}
  </div>

  <style>
    /* Connection Notification (Inline Alert) */
    .connection-notification {
      background-color: var(--surface);
      border: 2px solid var(--warning);
      border-radius: var(--radius);
      padding: 0.875rem;
      color: var(--text-primary);
      max-width: 450px;
      box-shadow: var(--shadow-md);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .connection-notification i {
      color: var(--warning);
      font-size: 1.1rem;
    }

    .connection-notification strong {
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .connection-notification .small {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .connection-notification .btn-close {
      opacity: 0.6;
    }

    .connection-notification .btn-close:hover {
      opacity: 1;
    }

    .connection-notification .btn-primary {
      background-color: var(--warning);
      border-color: var(--warning);
      color: var(--text-white);
      font-weight: 500;
      font-size: 0.875rem;
    }

    .connection-notification .btn-primary:hover {
      background-color: var(--accent-dark);
      border-color: var(--accent-dark);
    }

    /* Connection Status Indicator */
    .connection-status {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      font-size: 0.875rem;
      gap: 0.5rem;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .connection-status-icon {
      font-size: 1rem;
      transition: color 0.3s ease;
    }

    .connection-status-text {
      font-weight: 500;
      transition: color 0.3s ease;
    }

    /* Online state (green) */
    .connection-status.online .connection-status-icon {
      color: var(--success, #2ecc71);
    }

    .connection-status.online .connection-status-text {
      color: var(--success, #2ecc71);
    }

    /* Offline state (warning/orange) */
    .connection-status.offline .connection-status-icon {
      color: var(--warning, #f39c12);
    }

    .connection-status.offline .connection-status-text {
      color: var(--warning, #f39c12);
    }

    /* Pulse animation for offline state */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .connection-status.offline .connection-status-icon {
      animation: pulse 2s ease-in-out infinite;
    }

    /* Sync Pending Indicator */
    .sync-pending-indicator {
      padding: 0.25rem 0.5rem;
      text-align: left;
      margin-top: 0.25rem;
    }

    .sync-pending-indicator small {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .sync-pending-indicator i {
      animation: rotate 2s linear infinite;
    }

    @keyframes rotate {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    /* Sync Successful Indicator */
    .sync-successful-indicator {
      padding: 0.25rem 0.5rem;
      text-align: left;
      margin-top: 0.25rem;
      animation: fadeOut 3s ease-out forwards;
    }

    .sync-successful-indicator small {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--success);
    }

    @keyframes fadeOut {
      0% {
        opacity: 1;
      }
      70% {
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }
  </style>
{% endblock content %}

{% block scripts %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.4/purify.min.js" integrity="sha512-Y1p/STLW/B+l+MPJ5K5OdILMwJa2gMFXXmC/qsyDuGH9uc1MZMUo6/8YQUg9Ut4ns8KGCrCtt+58UwmNFFiVvA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  {% load static %}
  <script src="{% static 'js/connection-handler.js' %}"></script>
  <script>

  // ==========================================================================
  // Connection Handler Integration
  // ==========================================================================

  // Initialize connection handler for this key question
  // Use chat_id + question_id for unique storage keys
  const connectionHandler = new ConnectionHandler({
    chatId: '{{ chat.id }}_{{ question_id }}',
    heartbeatUrl: '{% url "key-questions" chat_id=chat.id question_id=question_id %}',
    onConnectionChange: function(isOnline) {
      console.log(`Connection status changed: ${isOnline ? 'online' : 'offline'}`);
    }
  });

  // Wrapper functions for backwards compatibility with HTML onclick attributes
  function retryConnection() {
    connectionHandler.retryConnection()
      .then(success => {
        if (!success) {
          alert('Connection still unavailable. Please check your internet connection and try again.');
        }
      });
  }

  function dismissConnectionNotification() {
    connectionHandler.dismissNotification();
  }

  // ==========================================================================
  // Key Questions Specific Functionality
  // ==========================================================================

  // Global variable for speech to text
  let active_speech = false;

  // Setup auto-save for user input
  let autoSaveTimeout = null;
  function setupAutoSave() {
    $('#user-input').on('input', function() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        connectionHandler.saveCachedInput($('#user-input').val());
      }, CONFIG.CACHE_SAVE_INTERVAL);
    });
  }

  // Initialize on document ready
  $(document).ready(function() {
    // Start connection monitoring
    connectionHandler.start();

    // Setup input auto-save
    setupAutoSave();

    // Restore cached input if any
    const cachedInput = connectionHandler.restoreCachedInput();
    if (cachedInput) {
      $('#user-input').val(cachedInput);
      // Adjust textarea height
      const chatInput = document.getElementById('user-input');
      if (chatInput) {
        chatInput.style.height = 'auto';
        chatInput.style.height = chatInput.scrollHeight + 'px';
      }
    }
  });

  // Restore answer to input field if send fails (key-questions specific)
  // This function recreates the entire input card if it was removed
  function restorePendingMessage() {
    const pendingMessage = localStorage.getItem(connectionHandler.storageKeys.pending);
      if (pendingMessage) {
        // Re-enable input card if it was removed
        if ($('#inputCard').length === 0) {
          $('#questions-container').prepend(`
            <div id="inputCard" class="input-card card mb-3 mt-3">
              <div class="card-body">
                <div class="d-flex">
                  <textarea id="user-input" class="chat-input flex-grow-1 border-0 p-2" placeholder="Enter text here..."></textarea>
                  <button class="button-chat-send btn btn-primary ms-2" type="button" onclick="sendMessage()">Send</button>
                </div>
                <!-- Connection notification and status row -->
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <!-- Connection Dropped Notification (Inline) -->
                  <div id="connectionDroppedNotification" class="connection-notification" style="display: none;">
                    <div class="d-flex align-items-center">
                      <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                          <i class="bi bi-wifi-off me-2"></i>
                          <strong>Connection Lost</strong>
                        </div>
                        <p class="mb-2 small">Disconnected at <span id="connectionDropTime"></span>. Your answer will be saved locally.</p>
                        <button type="button" class="btn btn-primary btn-sm" onclick="retryConnection()">Retry</button>
                      </div>
                      <button type="button" class="btn-close ms-2" onclick="dismissConnectionNotification()" aria-label="Close"></button>
                    </div>
                  </div>
                  <!-- Connection Status Indicator -->
                  <div id="connection-status" class="connection-status">
                    <i class="bi bi-wifi-off connection-status-icon"></i>
                    <span class="connection-status-text">Saved locally</span>
                  </div>
                </div>
              </div>
            </div>
          `);
          // Set status to offline since we're restoring after an error
          connectionHandler.updateConnectionStatus(false);
          setupAutoSave(); // Re-setup auto-save for new input field
        }

        $('#user-input').val(pendingMessage);
        // Adjust textarea height
        const chatInput = document.getElementById('user-input');
        if (chatInput) {
          chatInput.style.height = 'auto';
          chatInput.style.height = chatInput.scrollHeight + 'px';
          // Move cursor to end
          chatInput.focus();
          chatInput.setSelectionRange(pendingMessage.length, pendingMessage.length);
        }
      }
    }

    var start = Date.now();

    var timer = {{ question.duration }};

    let timerInterval = setInterval(function() {
      // stop timer when user container is in DOM
      if ($("#user-response-container").length) {
        clearInterval(timerInterval); // Stop the interval
      }

      var delta = Date.now() - start; // milliseconds elapsed since start

      timer = timer - 1

      // console.log(timer); // in seconds

      var raw_percent = (timer / {{ question.duration }}) * 100;
      raw_percent = raw_percent.toFixed(2)
      const percent = raw_percent + "%"
      // console.log(percent);

      $("#timer-bar").css("width", percent);
      $("#timer-text").text(timer + "s");

      if (timer === 0) {
        clearInterval(timerInterval); // Stop the interval
        
        // Remove text box
        $('#inputCard').remove();

        // add retry button to the page
        $("#questions-container").append("<button class=\"button-chat-send btn btn-primary mb-2\" type=\"button\" onclick=\"location.reload()\">Retry</button>");
      }
  }, 1000); // update about every second
  </script>
  <script>




  //global variable because of everytime you click the button of speech to text it will alternate
  // and if store it in there it will not alternate
  let active_speech = false;


    function textToSpeech(button) {
      //Because there are multiple chat messages, it grabs by the previous one
      let ai_message = button.previousElementSibling.innerText;
      //cancels it to prevent multiple from playing
      window.speechSynthesis.cancel();
      //speech
      let speech = new SpeechSynthesisUtterance();
      //binds speech text to the message
      speech.text = ai_message;
      //talks about ai message
      window.speechSynthesis.speak(speech);
      
      
   }

   function speechToText() {
    //gets the button of when to start/stop listening
    const button = document.getElementById('speech-text');
    const textbox = document.getElementById('user-input');
    //creates a way to listen
    const Listener = window.webkitSpeechRecognition;
    const recognition = new Listener();
    //display results while you are talking
    recognition.interimResults = true;
    //stops code if you stop talking
    recognition.continuous = true;
    //because of interim results it will display as it goes along
    recognition.onresult = (event) => {
      //stores text for each time of listening
      let text = '';
      //goes through the stored text from the event
      for (let i = event.resultIndex; i < event.results.length; i++) {
        //stores text
        text += event.results[i][0].transcript;
      }
      //places text in textbox
      textbox.value = text;
    };
    //button to alternate between stop and start
    button.addEventListener('click', () => {
      //if active is true it stops it, which well then go to onend
      if (active_speech) {
        //Stops listening
        recognition.stop();
      } 
      else {
        //starts listening
        recognition.start();
        active_speech = true;
        //shows people to click to stop
        button.textContent = 'Stop';
      }
    });
    //can be stopped by button or silence
    recognition.onend = () => {
      //resets the text box
      button.textContent = 'Speak';
      //alternates back to false
      active_speech = false;
    };
  }
  
  
    
    // Move the chat scroll to the bottom
    function updateScroll(){
      var element = document.getElementById("chat-scroll");
      element.scrollTop = element.scrollHeight;
    }

    {% comment %} $(document).ready(function() {
      updateScroll();
    }); {% endcomment %}
    

    const chatInput = document.getElementById('user-input');
    chatInput.addEventListener('input', function() {
      // Reset height to recalc scrollHeight
      this.style.height = 'auto';
      // Set the height based on the scrollHeight, which grows as needed
      var scrollHeight = this.scrollHeight
      
      // Conditionally increase the size of the textarea
      if (scrollHeight < 200) {
        this.style.height = scrollHeight + 'px';
      } else {
        this.style.height = '200px';
      }
    });
    

    {% comment %} Jquery script adpated from chatgpt {% endcomment %}
    function sendMessage() {
      var userInput = $('#user-input').val();
      if (userInput.trim() !== '') {
        const sanitizedUserInput = DOMPurify.sanitize(userInput.replace(/(?:\r\n|\r|\n)/g, '<br>'));

        // Save answer to pending cache BEFORE clearing input
        connectionHandler.savePendingMessage(userInput);

        $('#user-input').val('');
        // Clear regular cache (but keep pending cache until success)
        localStorage.removeItem(connectionHandler.storageKeys.cache);
        // Reset height to recalc scrollHeight
        chatInput.style.height = 'auto';
        chatInput.style.height = chatInput.scrollHeight + 'px';

        // Remove text box
        $('#inputCard').remove();

        // Generate unique ID for this answer
        const messageId = 'user-answer-' + Date.now();

        // Show user text bubble
        $('#chat-messages').append(
            `<div id="${messageId}" class="col user-text-container">
              <div class="card user-text-bubble">
                <div class="card-body">
                  <p class="card-text">${sanitizedUserInput}</p>
                </div>
              </div>
            </div>`);

        // Show loading bubble
        $('#chat-messages').append(
          `<div id="loading-bubble" class="col bot-text-container">
            <div class="card bot-text-bubble">
              <div class="card-body">
                <img src={% static 'images/loading.gif' %} alt="Loading..." class="loading-gif">
              </div>
            </div>
          </div>`);

        updateScroll();

        // POST the user message to the view
        $.ajax({
          url: `{% url "key-questions" chat_id=chat.id question_id=question_id %}`,
          type: 'POST',
          data: {
            'message': userInput,
            csrfmiddlewaretoken: '{{ csrf_token }}'
          },
          timeout: CONFIG.AJAX_TIMEOUT,
          success: function(response) {
            const sanitizedResponseMessage = DOMPurify.sanitize(response.message.replace(/(?:\r\n|\r|\n)/g, '<br>'));

            // delete loading bubble
            $('#loading-bubble').remove();

            // Show the response bubble
            $('#chat-messages').append(
                `<div class="col bot-text-container">
                  <div class="card bot-text-bubble">
                    <div class="card-body">
                      <p class="card-text" id = "ai_message">${sanitizedResponseMessage}</p>
                    </div>
                  </div>
                </div>`);

            // Answer sent successfully - clear ALL caches including pending
            connectionHandler.clearAllCaches();

            // Update connection status to online and dismiss notification
            connectionHandler.updateConnectionStatus(true);
            connectionHandler.dismissNotification();

            // add retry button to the page
            $("#questions-container").append("<button class=\"button-chat-send btn btn-primary mb-2\" type=\"button\" onclick=\"location.reload()\">Retry</button>");

            updateScroll();
          },
          error: function(xhr, status, error) {
            // Remove loading bubble
            $('#loading-bubble').remove();

            // Check if it's a network error or timeout
            if (status === 'timeout' || status === 'error' || xhr.status === 0) {
              // Keep the answer visible but add "Sync Pending" indicator
              connectionHandler.addSyncPendingIndicator(messageId);

              // Add to pending sync queue
              connectionHandler.addToPendingSync(userInput, messageId);

              // Clear pending message cache since we've added it to sync queue
              connectionHandler.clearPendingMessage();

              // Show connection dropped notification
              connectionHandler.showConnectionDroppedNotification();
            } else {
              // For non-network errors, remove the answer and restore to input
              $(`#${messageId}`).remove();
              restorePendingMessage();

              // Show generic error message in chat
              $('#chat-messages').append(
                  `<div class="col bot-text-container">
                    <div class="card bot-text-bubble bg-danger bg-opacity-10">
                      <div class="card-body">
                        <p class="card-text text-danger">Error: Unable to send answer. Your answer has been restored to the input field.</p>
                      </div>
                    </div>
                  </div>`);
            }

            updateScroll();
          }
        });
      }
    }

  // Custom sync function for key questions that shows AI responses
  function syncKeyQuestionAnswer(messageText) {
    return new Promise((resolve, reject) => {
      $.ajax({
        url: '{% url "key-questions" chat_id=chat.id question_id=question_id %}',
        type: 'POST',
        data: {
          'message': messageText,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        timeout: CONFIG.AJAX_TIMEOUT,
        success: function(response) {
          resolve(response);
        },
        error: function(xhr, status, error) {
          reject(new Error(`Sync failed: ${status}`));
        }
      });
    });
  }

  // Override the connection handler's sync to use our custom logic for key questions
  connectionHandler.syncPendingMessages = async function() {
    const pendingMessages = this.getPendingMessages();
    if (pendingMessages.length === 0) {
      return Promise.resolve();
    }

    console.log(`Attempting to sync ${pendingMessages.length} pending answer(s)...`);

    const message = pendingMessages[0];

    try {
      const response = await syncKeyQuestionAnswer(message.message);
      const sanitizedAiResponse = DOMPurify.sanitize(response.message.replace(/(?:\r\n|\r|\n)/g, '<br>'));

      // Show sync successful
      connectionHandler.showSyncSuccessful(message.elementId);

      // delete loading bubble if it exists
      $('#loading-bubble').remove();

      // Show the AI response bubble
      $('#chat-messages').append(
          `<div class="col bot-text-container">
            <div class="card bot-text-bubble">
              <div class="card-body">
                <p class="card-text" id="ai_message">${sanitizedAiResponse}</p>
              </div>
            </div>
          </div>`);

      // Add retry button to the page if not already present
      if ($('.button-chat-send.mb-2').length === 0) {
        $("#questions-container").append("<button class=\"button-chat-send btn btn-primary mb-2\" type=\"button\" onclick=\"location.reload()\">Retry</button>");
      }

      // Remove from queue
      pendingMessages.shift();
      this.savePendingMessages(pendingMessages);

      console.log('Answer synced successfully');
      this.updateConnectionStatus(true);
      updateScroll();

      // If more messages, sync them
      if (pendingMessages.length > 0) {
        setTimeout(() => this.syncPendingMessages(), CONFIG.SYNC_RETRY_DELAY);
      }

      return response;
    } catch (error) {
      console.log('Sync failed, will retry later');
      this.updateConnectionStatus(false);
      throw error;
    }
  };

    // send text on enter
    $('#user-input').on('keypress', function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        // prevent default behavior
        e.preventDefault();

        sendMessage();

        $(this).val('');

        // Reset height to recalc scrollHeight
        this.style.height = 'auto';
        // Set the height based on the scrollHeight, which grows as needed
        this.style.height = this.scrollHeight + 'px';
      }
    });
  </script>
{% endblock scripts %}
