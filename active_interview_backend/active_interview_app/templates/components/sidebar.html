<div class="chat-sidebar d-flex flex-column flex-grow-1">
  <div class="overflow-y-auto px-3 w-100 sidebar-content">
    {% comment %} <a href="{% url "chat-create" %}" class="full-block-link">
      <div class="button-card card mb-3 mt-3">
        <div class="card-body">
          <p class="card-text">New Interview</p>
        </div>
      </div>
    </a> {% endcomment %}
    <a role="button" class="btn btn-primary w-100 mt-3" href="{% url 'chat-create' %}">
      New Interview
    </a>
    <hr class="white-break">

    <!-- Practice Interviews Section -->
    {% with practice_chats=owner_chats|dictsort:"interview_type" %}
      {% for owner_chat in practice_chats %}
        {% if owner_chat.interview_type == 'PRACTICE' %}
          {% if forloop.first %}
            <h6 class="text-muted px-2 mt-3 mb-2" style="font-size: 0.85rem; font-weight: 600;">Practice Interviews</h6>
          {% endif %}
          <div class="chat-card card mb-3">
            <div class="d-flex">
              <a role="button" class="chat-card-button full-block-link btn btn-dark flex-grow-1 rounded-0 rounded-start {% if chat.id == owner_chat.id %}active{% endif %}" href="{% url 'chat-view' chat_id=owner_chat.id %}">
                <p class="chat-card-text card-text text-start m-0">{{ owner_chat.title }}</p>
              </a>
              <div class="d-flex flex-shrink-0">
                <div class="btn-group dropend">
                  <button type="button" class="{% if chat.id == owner_chat.id %}active-sidebar-dropdown{% else %}chat-card-button{% endif %} sidebar-dropend btn btn-dark dropdown-toggle dropdown-toggle-split rounded-0 rounded-end" data-bs-toggle="dropdown" data-bs-popper-config='{"strategy":"fixed"}' aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropend</span>
                  </button>
                  <ul class="sidebar-dropdown-menu dropdown-menu">
                    {% if not owner_chat.is_finalized %}
                      <!-- In-progress practice interview -->
                      <li><a class="sidebar-dropdown-item dropdown-item" href="{% url 'chat-edit' chat_id=owner_chat.id %}">Edit</a></li>
                      <li><a class="sidebar-dropdown-item dropdown-item" href="{% url 'key-questions' chat_id=owner_chat.id question_id=0 %}">Key Questions</a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <form method="POST" action="{% url 'finalize_interview' chat_id=owner_chat.id %}" style="margin: 0;">
                          {% csrf_token %}
                          <button type="submit" class="sidebar-dropdown-item dropdown-item btn btn-link text-start" style="width: 100%; padding: 0.25rem 1rem; border: none; background: none;">
                            Finish Interview
                          </button>
                        </form>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="sidebar-dropdown-item dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#restartChatModal" data-chat-title="{{ owner_chat.title }}" data-chat-link="{% url 'chat-restart' chat_id=owner_chat.id %}">
                          Restart
                        </a>
                      </li>
                      <li>
                        <a class="sidebar-dropdown-item dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteChatModal" data-chat-title="{{ owner_chat.title }}" data-chat-link="{% url 'chat-delete' chat_id=owner_chat.id %}">
                          Delete
                        </a>
                      </li>
                    {% else %}
                      <!-- Finalized practice interview -->
                      <li><a class="sidebar-dropdown-item dropdown-item" href="{% url 'export_report' chat_id=owner_chat.id %}">View Report</a></li>
                      <li><a class="sidebar-dropdown-item dropdown-item" href="{% url 'key-questions' chat_id=owner_chat.id question_id=0 %}">Key Questions</a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="sidebar-dropdown-item dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteChatModal" data-chat-title="{{ owner_chat.title }}" data-chat-link="{% url 'chat-delete' chat_id=owner_chat.id %}">
                          Delete
                        </a>
                      </li>
                    {% endif %}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% endwith %}

    <!-- Invited Interviews Section -->
    {% with invited_chats=owner_chats|dictsort:"interview_type" %}
      {% for owner_chat in invited_chats %}
        {% if owner_chat.interview_type == 'INVITED' %}
          {% if forloop.first %}
            <h6 class="text-muted px-2 mt-4 mb-2" style="font-size: 0.85rem; font-weight: 600;">Invited Interviews</h6>
          {% endif %}
          <div class="chat-card card mb-3">
            <div class="d-flex">
              <a role="button" class="chat-card-button full-block-link btn btn-dark flex-grow-1 rounded-0 rounded-start {% if chat.id == owner_chat.id %}active{% endif %}" href="{% url 'chat-view' chat_id=owner_chat.id %}">
                <div class="d-flex align-items-center justify-content-between w-100">
                  <p class="chat-card-text card-text text-start m-0">{{ owner_chat.title }}</p>
                  <span class="badge rounded-pill ms-2" style="background-color: var(--info); color: var(--text-white); font-size: 0.65rem;">Invited</span>
                </div>
              </a>
              <div class="d-flex flex-shrink-0">
                <div class="btn-group dropend">
                  <button type="button" class="{% if chat.id == owner_chat.id %}active-sidebar-dropdown{% else %}chat-card-button{% endif %} sidebar-dropend btn btn-dark dropdown-toggle dropdown-toggle-split rounded-0 rounded-end" data-bs-toggle="dropdown" data-bs-popper-config='{"strategy":"fixed"}' aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropend</span>
                  </button>
                  <ul class="sidebar-dropdown-menu dropdown-menu">
                    {% if owner_chat.is_finalized %}
                      <!-- Check if interviewer has reviewed -->
                      {% with invitation=owner_chat.invitation.first %}
                        {% if invitation.interviewer_review_status == 'pending' %}
                          <!-- Pending interviewer review -->
                          <li><span class="sidebar-dropdown-item dropdown-item text-muted" style="cursor: default;">Pending Interviewer Review</span></li>
                        {% else %}
                          <!-- Reviewed - show full report -->
                          <li><a class="sidebar-dropdown-item dropdown-item" href="{% url 'export_report' chat_id=owner_chat.id %}">View Report</a></li>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      <!-- In-progress invited interview -->
                      <li><span class="sidebar-dropdown-item dropdown-item text-muted" style="cursor: default;">Interview In Progress</span></li>
                    {% endif %}
                    <li><a class="sidebar-dropdown-item dropdown-item" href="{% url 'key-questions' chat_id=owner_chat.id question_id=0 %}">Key Questions</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <a class="sidebar-dropdown-item dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteChatModal" data-chat-title="{{ owner_chat.title }}" data-chat-link="{% url 'chat-delete' chat_id=owner_chat.id %}">
                        Delete
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% endwith %}
  </div>
</div>
