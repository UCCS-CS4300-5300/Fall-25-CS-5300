{% extends "base.html" %}
{% load static %}
{% load ratelimit_extras %}
{% block title %}
  Violation Analytics - Active Interview
{% endblock title %}
{% block content %}
  <div class="container-fluid mt-4">
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1>
            <i class="fas fa-chart-bar"></i> Rate Limit Violation Analytics
          </h1>
          <a href="{% url 'ratelimit_dashboard' %}"
             class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </a>
        </div>
      </div>
    </div>
    <!-- Time Range Selector -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <form method="get" class="row g-3">
              <div class="col-auto">
                <label for="days" class="col-form-label">Time Range:</label>
              </div>
              <div class="col-auto">
                <select name="days"
                        id="days"
                        class="form-select"
                        onchange="this.form.submit()">
                  <option value="1" {% if days == 1 %}selected{% endif %}>Last 24 Hours</option>
                  <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 Days</option>
                  <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 Days</option>
                  <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 Days</option>
                </select>
              </div>
              <div class="col-auto">
                <span class="text-muted">Total Violations: {{ total_violations }}</span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Hourly Distribution -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Violations by Hour of Day</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    {% for hour in "000000000000000000000000"|make_list %}<th class="text-center">{{ forloop.counter0 }}</th>{% endfor %}
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    {% for count in hourly_dist %}
                      <td class="text-center">
                        {% if count > 0 %}
                          <span class="badge bg-danger">{{ count }}</span>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                </tbody>
              </table>
            </div>
            <small class="text-muted">Hours are in UTC</small>
          </div>
        </div>
      </div>
    </div>
    <!-- Daily Distribution -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Violations by Day of Week</h5>
          </div>
          <div class="card-body">
            <table class="table table-sm">
              <tbody>
                <tr>
                  <th>Monday</th>
                  <td class="text-end">
                    <span class="badge bg-primary">{{ daily_dist.0 }}</span>
                  </td>
                </tr>
                <tr>
                  <th>Tuesday</th>
                  <td class="text-end">
                    <span class="badge bg-primary">{{ daily_dist.1 }}</span>
                  </td>
                </tr>
                <tr>
                  <th>Wednesday</th>
                  <td class="text-end">
                    <span class="badge bg-primary">{{ daily_dist.2 }}</span>
                  </td>
                </tr>
                <tr>
                  <th>Thursday</th>
                  <td class="text-end">
                    <span class="badge bg-primary">{{ daily_dist.3 }}</span>
                  </td>
                </tr>
                <tr>
                  <th>Friday</th>
                  <td class="text-end">
                    <span class="badge bg-primary">{{ daily_dist.4 }}</span>
                  </td>
                </tr>
                <tr>
                  <th>Saturday</th>
                  <td class="text-end">
                    <span class="badge bg-primary">{{ daily_dist.5 }}</span>
                  </td>
                </tr>
                <tr>
                  <th>Sunday</th>
                  <td class="text-end">
                    <span class="badge bg-primary">{{ daily_dist.6 }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- User Agent Analysis -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Violations by Client Type</h5>
          </div>
          <div class="card-body">
            {% if user_agents %}
              <table class="table table-sm">
                <tbody>
                  {% for category, count in user_agents.items %}
                    <tr>
                      <th>{{ category }}</th>
                      <td class="text-end">
                        <span class="badge bg-info">{{ count }}</span>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p class="text-muted">No data available</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <!-- Geographic Distribution -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Violations by Country (Top 10)</h5>
          </div>
          <div class="card-body">
            {% if geo_dist %}
              <div class="table-responsive">
                <table class="table table-sm table-striped">
                  <thead>
                    <tr>
                      <th>Country Code</th>
                      <th class="text-end">Violations</th>
                      <th style="width: 60%;">Distribution</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in geo_dist %}
                      <tr>
                        <td>
                          {% if item.country_code %}
                            {{ item.country_code }}
                          {% else %}
                            <span class="text-muted">Unknown</span>
                          {% endif %}
                        </td>
                        <td class="text-end">{{ item.count }}</td>
                        <td>
                          <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-warning"
                                 role="progressbar"
                                 style="width: {{ item.count|multiply:100|divide:total_violations }}%"
                                 aria-valuenow="{{ item.count }}"
                                 aria-valuemin="0"
                                 aria-valuemax="{{ total_violations }}"></div>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted">No geographic data available</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <!-- Actions -->
    <div class="row mb-4">
      <div class="col-12">
        <a href="{% url 'ratelimit_dashboard' %}" class="btn btn-primary">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <a href="{% url 'export_violations' %}?days={{ days }}"
           class="btn btn-success">
          <i class="fas fa-download"></i> Export Data
        </a>
      </div>
    </div>
  </div>
  <style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .progress {
        margin-bottom: 0;
    }
  </style>
  <script>
// Custom template filters need to be handled differently in production
// These are simplified display helpers
  </script>
{% endblock content %}
