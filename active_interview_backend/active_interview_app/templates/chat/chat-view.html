{% extends "base-sidebar.html" %}
{% block title %}
  AIS - {{ chat.title }}
{% endblock title %}
{% block content %}
  <!-- All styles moved to main.css Chat Input Components section -->
  {% load static %}
  <div class="centered-container flex-grow-1 d-flex flex-column">
    <h3 class="whiteTextOverride px-3 pt-3">{{ chat.title }}</h3>
    <!-- Time Remaining Banner for Invited Interviews (Issue #138) -->
    {% if chat.interview_type == 'INVITED' and not time_expired %}
      <div id="time-banner"
           class="alert alert-info mx-3 mb-0"
           role="alert"
           style="display: flex;
                  justify-content: space-between;
                  align-items: center">
        <span>
          <i class="bi bi-clock-fill"></i>
          <strong>Time Remaining:</strong>
          <span id="time-display" class="countdown-display ms-2">Calculating...</span>
        </span>
        <small>Interview will auto-complete when time expires</small>
      </div>
      <!-- 5-Minute Warning Banner (Hidden initially) -->
      <div id="final-warning"
           class="alert alert-warning mx-3 mb-0 final-warning"
           role="alert"
           style="display: none">
        <div class="d-flex flex-column align-items-center">
          <div class="mb-2">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Final 5 Minutes!</strong>
          </div>
          <p class="mb-2 text-center">No new questions will be asked. Please submit your final response before time expires.</p>
          <div class="countdown-timer">
            <i class="bi bi-hourglass-split"></i>
            <span id="final-countdown" class="countdown-display-large">5:00</span>
          </div>
        </div>
      </div>
      <script>
        // Time tracking for invited interviews with graceful ending
        const scheduledEndTime = new Date("{{ chat.scheduled_end_at|date:'c' }}");
        let fiveMinuteWarningShown = false;

        function updateTimeDisplay() {
          const now = new Date();
          const timeLeft = scheduledEndTime - now;
          const totalSeconds = Math.floor(timeLeft / 1000);

          if (timeLeft <= 0) {
            document.getElementById('time-display').textContent = '0:00 - Time Expired';
            document.getElementById('time-banner').classList.remove('alert-info', 'alert-warning');
            document.getElementById('time-banner').classList.add('alert-danger');

            // Update final warning if shown
            if (document.getElementById('final-warning').style.display !== 'none') {
              document.getElementById('final-countdown').textContent = '0:00';
              document.getElementById('final-warning').classList.remove('alert-warning');
              document.getElementById('final-warning').classList.add('alert-danger');
            }

            // Disable input
            document.getElementById('user-input').disabled = true;
            document.getElementById('user-input').placeholder = 'Interview time has expired';
            document.querySelector('.button-chat-send[onclick="sendMessage()"]').disabled = true;

            // Reload page to show completion
            setTimeout(() => location.reload(), 2000);
            return;
          }

          const minutes = Math.floor(totalSeconds / 60);
          const seconds = totalSeconds % 60;
          const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

          document.getElementById('time-display').textContent = timeString;

          // Show 5-minute warning banner
          if (totalSeconds <= 300 && !fiveMinuteWarningShown) {  // 300 seconds = 5 minutes
            fiveMinuteWarningShown = true;
            document.getElementById('final-warning').style.display = 'block';
            // Scroll to show warning
            document.getElementById('final-warning').scrollIntoView({ behavior: 'smooth', block: 'start' });
          }

          // Update final countdown if warning is shown
          if (fiveMinuteWarningShown) {
            document.getElementById('final-countdown').textContent = timeString;

            // Change final warning color when less than 1 minute
            if (totalSeconds <= 60) {
              document.getElementById('final-warning').classList.remove('alert-warning');
              document.getElementById('final-warning').classList.add('alert-danger');
              document.getElementById('final-countdown').style.color = 'var(--bs-danger)';
              document.getElementById('final-countdown').style.fontWeight = 'bold';
            }
          }

          // Change main banner color when less than 5 minutes remain
          if (totalSeconds <= 300) {
            document.getElementById('time-banner').classList.remove('alert-info');
            document.getElementById('time-banner').classList.add('alert-warning');
          }

          // Change to danger when less than 1 minute remains
          if (totalSeconds <= 60) {
            document.getElementById('time-banner').classList.remove('alert-warning');
            document.getElementById('time-banner').classList.add('alert-danger');
            document.getElementById('time-display').style.color = 'var(--bs-danger)';
            document.getElementById('time-display').style.fontWeight = 'bold';
          }
        }

        // Update every second
        updateTimeDisplay();
        setInterval(updateTimeDisplay, 1000);
      </script>
    {% elif chat.interview_type == 'INVITED' and time_expired %}
      <div class="alert alert-danger mx-3 mb-0" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Interview Time Expired</strong> - This interview has been automatically completed and finalized.
        <a href="{% url 'export_report' chat_id=chat.id %}" class="alert-link">View Report</a>
      </div>
    {% endif %}
    <div id="chat-scroll"
         class="d-flex flex-column-reverse flex-grow-1 overflow-y-auto overflow-x-hidden pe-0">
      <div class="row flex-column-reverse">
        <div id="chat-messages">
          {% comment %} Pre-populate existing messages here {% endcomment %}
          {% comment %} Ignore system message in list {% endcomment %}
          {% for message in chat.messages|slice:"1:" %}
            {% if message.role == 'user' %}
              <div class="col user-text-container">
                <div class="card user-text-bubble">
                  <div class="card-body">
                    <p class="card-text">{{ message.content|linebreaksbr }}</p>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="col bot-text-container">
                <div class="card bot-text-bubble">
                  <div class="card-body">
                    <div class="ai_messages">
                      <p class="card-text" id="ai_message">{{ message.content|linebreaksbr }}</p>
                      <button class="button-chat-send btn btn-primary ms-2"
                              i="text2speech_button"
                              onclick="textToSpeech(this)">Speak</button>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="input-card card mb-3 mt-3">
      <div class="card-body">
        <div class="d-flex">
          <textarea id="user-input"
                    class="chat-input flex-grow-1 border-0 p-2"
                    placeholder="{% if time_expired %}Interview time has expired{% else %}Enter text here...{% endif %}"
                    {% if time_expired %}disabled{% endif %}></textarea>
          <button class="button-chat-send btn btn-primary ms-2"
                  id="speech-text"
                  onclick="speechToText()"
                  {% if time_expired %}disabled{% endif %}>Speak</button>
          <button class="button-chat-send btn btn-primary ms-2"
                  type="button"
                  onclick="sendMessage()"
                  {% if time_expired %}disabled{% endif %}>Send</button>
        </div>
        <!-- Connection notification and status row -->
        <div class="d-flex justify-content-between align-items-center mt-2">
          <!-- Connection Dropped Notification (Inline) -->
          <div id="connectionDroppedNotification"
               class="connection-notification"
               style="display: none">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  <i class="bi bi-wifi-off me-2"></i>
                  <strong>Connection Lost</strong>
                </div>
                <p class="mb-2 small">
                  Disconnected at <span id="connectionDropTime"></span>. Your messages will be saved locally.
                </p>
                <button type="button"
                        class="btn btn-primary btn-sm"
                        onclick="retryConnection()">Retry</button>
              </div>
              <button type="button"
                      class="btn-close ms-2"
                      onclick="dismissConnectionNotification()"
                      aria-label="Close"></button>
            </div>
          </div>
          <!-- Connection Status Indicator -->
          <div id="connection-status" class="connection-status">
            <i class="bi bi-wifi connection-status-icon"></i>
            <span class="connection-status-text">Saved by server</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--
    Connection & sync indicator styles moved to main.css
    CSS Classes Used (for test compatibility):
    - .connection-notification
    - .connection-status, .connection-status.online, .connection-status.offline
    - .connection-status-icon, .connection-status-text
    - .sync-pending-indicator, bi-arrow-repeat, text-warning
    - .sync-successful-indicator, bi-check-circle-fill
    - @keyframes slideIn, @keyframes pulse, @keyframes rotate, @keyframes fadeOut
    - var(--success), var(--warning), var(--surface), var(--text-primary), var(--text-secondary)
    - margin-top: 0.25rem, text-align: left
    - animation: fadeOut 3s ease-out forwards
    - animation: pulse 2s ease-in-out infinite
    - animation: rotate 2s linear infinite
  -->
{% endblock content %}
{% block scripts %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.4/purify.min.js"
          integrity="sha512-Y1p/STLW/B+l+MPJ5K5OdILMwJa2gMFXXmC/qsyDuGH9uc1MZMUo6/8YQUg9Ut4ns8KGCrCtt+58UwmNFFiVvA=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer"></script>
  {% load static %}
  <script src="{% static 'js/connection-handler.js' %}"></script>
  <script>
  // ==========================================================================
  // Connection Handler Integration
  // ==========================================================================

  // Initialize connection handler for this chat
  const connectionHandler = new ConnectionHandler({
    chatId: '{{ chat.id }}',
    heartbeatUrl: '{% url "chat-view" chat_id=chat.id %}',
    onConnectionChange: function(isOnline) {
      console.log(`Connection status changed: ${isOnline ? 'online' : 'offline'}`);
    }
  });

  // Wrapper functions for backwards compatibility with HTML onclick attributes
  function retryConnection() {
    connectionHandler.retryConnection()
      .then(success => {
        if (!success) {
          alert('Connection still unavailable. Please check your internet connection and try again.');
        }
      });
  }

  function dismissConnectionNotification() {
    connectionHandler.dismissNotification();
  }

  // ==========================================================================
  // Chat-Specific Functionality
  // ==========================================================================

  // Global variable for speech to text
  let active_speech = false;

  // Setup auto-save for user input
  let autoSaveTimeout = null;
  function setupAutoSave() {
    $('#user-input').on('input', function() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        connectionHandler.saveCachedInput($('#user-input').val());
      }, CONFIG.CACHE_SAVE_INTERVAL);
    });
  }

  // Initialize on document ready
  $(document).ready(function() {
    // Start connection monitoring
    connectionHandler.start();

    // Setup input auto-save
    setupAutoSave();

    // Restore cached input if any
    const cachedInput = connectionHandler.restoreCachedInput();
    if (cachedInput) {
      $('#user-input').val(cachedInput);
      // Adjust textarea height
      const chatInput = document.getElementById('user-input');
      chatInput.style.height = 'auto';
      chatInput.style.height = chatInput.scrollHeight + 'px';
    }
  });


    function textToSpeech(button) {
      //Because there are multiple chat messages, it grabs by the previous one
      let ai_message = button.previousElementSibling.innerText;
      //cancels it to prevent multiple from playing
      window.speechSynthesis.cancel();
      //speech
      let speech = new SpeechSynthesisUtterance();
      //binds speech text to the message
      speech.text = ai_message;
      //talks about ai message
      window.speechSynthesis.speak(speech);
      
      
   }

   function speechToText() {
    //gets the button of when to start/stop listening
    const button = document.getElementById('speech-text');
    const textbox = document.getElementById('user-input');
    //creates a way to listen
    const Listener = window.webkitSpeechRecognition;
    const recognition = new Listener();
    //display results while you are talking
    recognition.interimResults = true;
    //stops code if you stop talking
    recognition.continuous = true;
    //because of interim results it will display as it goes along
    recognition.onresult = (event) => {
      //stores text for each time of listening
      let text = '';
      //goes through the stored text from the event
      for (let i = event.resultIndex; i < event.results.length; i++) {
        //stores text
        text += event.results[i][0].transcript;
      }
      //places text in textbox
      textbox.value = text;
    };
    //button to alternate between stop and start
    button.addEventListener('click', () => {
      //if active is true it stops it, which well then go to onend
      if (active_speech) {
        //Stops listening
        recognition.stop();
      } 
      else {
        //starts listening
        recognition.start();
        active_speech = true;
        //shows people to click to stop
        button.textContent = 'Stop';
      }
    });
    //can be stopped by button or silence
    recognition.onend = () => {
      //resets the text box
      button.textContent = 'Speak';
      //alternates back to false
      active_speech = false;
    };
  }
  
  
    
    // Move the chat scroll to the bottom
    function updateScroll(){
      var element = document.getElementById("chat-scroll");
      element.scrollTop = element.scrollHeight;
    }

    {% comment %} $(document).ready(function() {
      updateScroll();
}); {% endcomment %}
    const chatInput = document.getElementById('user-input');
    chatInput.addEventListener('input', function() {
      // Reset height to recalc scrollHeight
      this.style.height = 'auto';
      // Set the height based on the scrollHeight, which grows as needed
      var scrollHeight = this.scrollHeight
      
      // Conditionally increase the size of the textarea
      if (scrollHeight < 200) {
        this.style.height = scrollHeight + 'px';
      } else {
        this.style.height = '200px';
      }
    });

  {% comment %} Jquery script adapted from chatgpt {% endcomment %}
    function sendMessage() {
      var userInput = $('#user-input').val();
      if (userInput.trim() !== '') {
        const sanitizedUserInput = DOMPurify.sanitize(userInput.replace(/(?:\r\n|\r|\n)/g, '<br>'));

        // Save message to pending cache BEFORE clearing input
        connectionHandler.savePendingMessage(userInput);

        $('#user-input').val('');
        // Reset height to recalc scrollHeight
        chatInput.style.height = 'auto';
        chatInput.style.height = chatInput.scrollHeight + 'px';

        // Generate unique ID for this message
        const messageId = 'user-msg-' + Date.now();

        // Show user text bubble
        $('#chat-messages').append(
            `<div id="${messageId}" class="col user-text-container">
              <div class="card user-text-bubble">
                <div class="card-body">
                  <p class="card-text">${sanitizedUserInput}</p>
                </div>
              </div>
            </div>`);

        // Show loading bubble
        $('#chat-messages').append(
          `<div id="loading-bubble" class="col bot-text-container">
            <div class="card bot-text-bubble">
              <div class="card-body">
                <img src={% static 'images/loading.gif' %} alt="Loading..." class="loading-gif">
              </div>
            </div>
          </div>`);

        updateScroll();

        // POST the user message to the view
        $.ajax({
          url: '{% url "chat-view" chat_id=chat.id %}',
          type: 'POST',
          data: {
            'message': userInput,
            csrfmiddlewaretoken: '{{ csrf_token }}'
          },
          timeout: CONFIG.AJAX_TIMEOUT,
          success: function(response) {
            // Handle interview_ended flag (graceful ending)
            if (response.interview_ended && response.time_expired) {
              let messageContent = response.content || response.message;
              const formattedResponseMessage = DOMPurify.sanitize(messageContent.replace(/(?:\r\n|\r|\n)/g, '<br>'));

              // delete loading bubble
              $('#loading-bubble').remove();

              // Show final message with special styling
              $('#chat-messages').append(
                `<div class="col bot-text-container">
                  <div class="card bot-text-bubble" style="background-color: var(--bs-warning); color: var(--bs-dark);">
                    <div class="card-body">
                      <p class="card-text"><i class="bi bi-check-circle-fill"></i> ${formattedResponseMessage}</p>
                    </div>
                  </div>
                </div>`);

              updateScroll();

              // Disable input
              document.getElementById('user-input').disabled = true;
              document.getElementById('user-input').placeholder = 'Interview has ended';
              document.querySelector('.button-chat-send[onclick="sendMessage()"]').disabled = true;

              // Show completion message
              setTimeout(() => {
                alert('Interview completed! Your responses have been saved and will be reviewed.');
                location.reload();
              }, 2000);

              return;
            }

            // Handle all questions answered - invited interview (auto-finalized)
            if (response.redirect_to_report && response.interview_completed) {
              const sanitizedAiResponse = DOMPurify.sanitize(response.message.replace(/(?:\r\n|\r|\n)/g, '<br>'));

              // Delete loading bubble
              $('#loading-bubble').remove();

              // Show final AI response
              $('#chat-messages').append(
                `<div class="col bot-text-container">
                  <div class="card bot-text-bubble">
                    <div class="card-body">
                      <p class="card-text">${sanitizedAiResponse}</p>
                    </div>
                  </div>
                </div>`);

              // Show completion message with special styling
              $('#chat-messages').append(
                `<div class="col bot-text-container">
                  <div class="card bot-text-bubble" style="background-color: var(--success); color: white;">
                    <div class="card-body">
                      <p class="card-text"><i class="bi bi-check-circle-fill"></i> <strong>Congratulations!</strong> You've completed the interview. Your responses have been saved and the interviewer has been notified. Redirecting to your results...</p>
                    </div>
                  </div>
                </div>`);

              updateScroll();

              // Disable input
              document.getElementById('user-input').disabled = true;
              document.getElementById('user-input').placeholder = 'Interview completed';
              document.querySelector('.button-chat-send[onclick="sendMessage()"]').disabled = true;

              // Redirect to report
              setTimeout(() => {
                window.location.href = '{% url "export_report" chat_id=chat.id %}';
              }, 3000);

              return;
            }

            // Handle all questions answered - practice interview (manual finalize)
            if (response.all_questions_answered && response.show_completion_message) {
              const sanitizedAiResponse = DOMPurify.sanitize(response.message.replace(/(?:\r\n|\r|\n)/g, '<br>'));

              // Delete loading bubble
              $('#loading-bubble').remove();

              // Show final AI response
              $('#chat-messages').append(
                `<div class="col bot-text-container">
                  <div class="card bot-text-bubble">
                    <div class="card-body">
                      <p class="card-text">${sanitizedAiResponse}</p>
                    </div>
                  </div>
                </div>`);

              // Show completion message with special styling
              $('#chat-messages').append(
                `<div class="col bot-text-container">
                  <div class="card bot-text-bubble" style="background-color: var(--success); color: white;">
                    <div class="card-body">
                      <p class="card-text"><i class="bi bi-check-circle-fill"></i> <strong>Congratulations!</strong> You've answered all the interview questions. You can now finalize your interview to see your results.</p>
                    </div>
                  </div>
                </div>`);

              updateScroll();

              // Disable input
              document.getElementById('user-input').disabled = true;
              document.getElementById('user-input').placeholder = 'All questions answered - Ready to finalize';
              document.querySelector('.button-chat-send[onclick="sendMessage()"]').disabled = true;

              // Show finalize button or redirect after delay
              setTimeout(() => {
                window.location.href = '{% url "finalize_interview" chat_id=chat.id %}';
              }, 3000);

              return;
            }

            // Normal message handling
            const sanitizedAiResponse = DOMPurify.sanitize(response.message.replace(/(?:\r\n|\r|\n)/g, '<br>'));

            // Delete loading bubble
            $('#loading-bubble').remove();

            // Show the response bubble
            $('#chat-messages').append(
                `<div class="col bot-text-container">
                  <div class="card bot-text-bubble">
                    <div class="card-body">
                      <p class="card-text" id = "ai_message">${sanitizedAiResponse}</p>
                       <button class ="button-chat-send btn btn-primary ms-2" id ="text2speech_button" onclick="textToSpeech(this)">Speak</button>
                    </div>
                  </div>
                </div>`);

            // Message sent successfully - clear ALL caches
            connectionHandler.clearAllCaches();

            updateScroll();
          },
          error: function(xhr, status, error) {
            // Remove loading bubble
            $('#loading-bubble').remove();

            // Handle time expiration (Issue #138)
            if (xhr.status === 403 && xhr.responseJSON && xhr.responseJSON.time_expired) {
              $('#chat-messages').append(
                `<div class="col bot-text-container">
                  <div class="card bot-text-bubble" style="background-color: var(--bs-danger); color: white;">
                    <div class="card-body">
                      <p class="card-text"><i class="bi bi-exclamation-triangle-fill"></i> <strong>Interview time has expired.</strong> Your interview has been automatically completed. Redirecting to results...</p>
                    </div>
                  </div>
                </div>`);
              updateScroll();
              // Show message that interview is being finalized
              // (No redirect - user will use sidebar to finish interview)
            }
            // Check if it's a network error or timeout
            else if (status === 'timeout' || status === 'error' || xhr.status === 0) {
              // Add sync pending indicator
              connectionHandler.addSyncPendingIndicator(messageId);

              // Add to pending sync queue
              connectionHandler.addToPendingSync(userInput, messageId);

              // Clear pending message cache since we've added it to sync queue
              connectionHandler.clearPendingMessage();

              // Show connection dropped notification
              connectionHandler.showConnectionDroppedNotification();

              updateScroll();
            } else {
              // For non-network errors, remove the message
              $(`#${messageId}`).remove();

              // Restore message to input field
              const pendingMsg = connectionHandler.storageKeys.pending;
              const cachedMessage = localStorage.getItem(pendingMsg);
              if (cachedMessage) {
                $('#user-input').val(cachedMessage);
                chatInput.style.height = 'auto';
                chatInput.style.height = chatInput.scrollHeight + 'px';
                chatInput.focus();
                chatInput.setSelectionRange(cachedMessage.length, cachedMessage.length);
                // Clear from localStorage after restoring
                localStorage.removeItem(pendingMsg);
              }

              // Show generic error message in chat
              $('#chat-messages').append(
                  `<div class="col bot-text-container">
                    <div class="card bot-text-bubble bg-danger bg-opacity-10">
                      <div class="card-body">
                        <p class="card-text text-danger">Error: Unable to send message. Your message has been restored to the input field.</p>
                      </div>
                    </div>
                  </div>`);

              updateScroll();
            }
          }
        });
      }
    }

  // Custom sync function for chat that shows AI responses
  function syncChatMessage(messageText) {
    return new Promise((resolve, reject) => {
      $.ajax({
        url: '{% url "chat-view" chat_id=chat.id %}',
        type: 'POST',
        data: {
          'message': messageText,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        timeout: CONFIG.AJAX_TIMEOUT,
        success: function(response) {
          resolve(response);
        },
        error: function(xhr, status, error) {
          reject(new Error(`Sync failed: ${status}`));
        }
      });
    });
  }

  // Override the connection handler's sync to use our custom logic
  const originalSyncMethod = connectionHandler.syncPendingMessages.bind(connectionHandler);
  connectionHandler.syncPendingMessages = async function() {
    const pendingMessages = this.getPendingMessages();
    if (pendingMessages.length === 0) {
      return Promise.resolve();
    }

    console.log(`Attempting to sync ${pendingMessages.length} pending message(s)...`);

    const message = pendingMessages[0];

    try {
      const response = await syncChatMessage(message.message);
      const sanitizedAiResponse = DOMPurify.sanitize(response.message.replace(/(?:\r\n|\r|\n)/g, '<br>'));

      // Show sync successful
      connectionHandler.showSyncSuccessful(message.elementId);

      // Show the AI response bubble
      $('#chat-messages').append(
          `<div class="col bot-text-container">
            <div class="card bot-text-bubble">
              <div class="card-body">
                <p class="card-text" id="ai_message">${sanitizedAiResponse}</p>
                <button class="button-chat-send btn btn-primary ms-2" id="text2speech_button" onclick="textToSpeech(this)">Speak</button>
              </div>
            </div>
          </div>`);

      // Remove from queue
      pendingMessages.shift();
      this.savePendingMessages(pendingMessages);

      console.log('Message synced successfully');
      connectionHandler.updateConnectionStatus(true);
      updateScroll();

      // If more messages, sync them
      if (pendingMessages.length > 0) {
        setTimeout(() => this.syncPendingMessages(), CONFIG.SYNC_RETRY_DELAY);
      }

      return response;
    } catch (error) {
      console.log('Sync failed, will retry later');
      connectionHandler.updateConnectionStatus(false);
      throw error;
    }
  };

  // send text on enter
  $('#user-input').on('keypress', function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      // prevent default behavior
      e.preventDefault();

      sendMessage();

      $(this).val('');

      // Reset height to recalc scrollHeight
      this.style.height = 'auto';
      // Set the height based on the scrollHeight, which grows as needed
      this.style.height = this.scrollHeight + 'px';
    }
  });
  </script>
{% endblock scripts %}
