{% extends "base.html" %}
{% block title %}
  AIS - Review Interview
{% endblock title %}
{% block content %}
  <style>
    .review-page {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-header h1 {
      color: var(--primary);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .page-header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .review-section {
      background: var(--surface-hover);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-sm);
    }

    .review-section h2 {
      color: var(--text-primary);
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .review-section h2::before {
      content: "";
      display: inline-block;
      width: 4px;
      height: 1.5rem;
      background: var(--primary);
      border-radius: 2px;
    }

    .metadata-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .metadata-item {
      display: flex;
      flex-direction: column;
    }

    .metadata-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .metadata-value {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 500;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-completed {
      background-color: var(--success);
      color: var(--text-white);
    }

    .status-pending {
      background-color: var(--warning);
      color: var(--text-primary);
    }

    .status-reviewed {
      background-color: var(--info);
      color: var(--text-white);
    }

    .chat-messages {
      max-height: 500px;
      overflow-y: auto;
      padding: 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .message {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: var(--radius);
    }

    .message-user {
      background: var(--primary-light);
      border-left: 4px solid var(--primary);
    }

    .message-assistant {
      background: var(--surface-hover);
      border-left: 4px solid var(--info);
    }

    .message-role {
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .message-content {
      color: var(--text-primary);
      line-height: 1.6;
    }

    .feedback-form {
      margin-top: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      background-color: var(--surface);
      color: var(--text-primary);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea.form-control {
      min-height: 150px;
      resize: vertical;
      font-family: inherit;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 2rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: var(--radius);
      border: 2px solid;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
      color: var(--text-white);
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-success {
      background-color: var(--success);
      border-color: var(--success);
      color: var(--text-white);
    }

    .btn-success:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background-color: var(--surface);
      border-color: var(--border);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background-color: var(--surface-hover);
      border-color: var(--primary);
    }

    .existing-feedback {
      background: var(--surface);
      border: 2px solid var(--info);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .existing-feedback h4 {
      color: var(--info);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .existing-feedback p {
      color: var(--text-primary);
      line-height: 1.6;
      margin: 0;
    }

    @media (max-width: 768px) {
      .review-page {
        padding: 0 1rem;
      }

      .review-section {
        padding: 1.5rem;
      }

      .metadata-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        text-align: center;
      }
    }
  </style>
  <div class="review-page">
    <!-- Page Header -->
    <div class="page-header">
      <h1>Review Interview</h1>
      <p>
        Provide feedback for candidate: <strong>{{ invitation.candidate_email }}</strong>
      </p>
    </div>
    <!-- Interview Metadata -->
    <div class="review-section">
      <h2>Interview Details</h2>
      <div class="metadata-grid">
        <div class="metadata-item">
          <span class="metadata-label">Template</span>
          <span class="metadata-value">{{ invitation.template.name }}</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Scheduled Time</span>
          <span class="metadata-value">{{ invitation.scheduled_time|date:"M d, Y g:i A" }}</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Duration</span>
          <span class="metadata-value">{{ invitation.duration_minutes }} minutes</span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Status</span>
          <span class="metadata-value">
            <span class="status-badge status-{{ invitation.status }}">{{ invitation.get_status_display }}</span>
          </span>
        </div>
        <div class="metadata-item">
          <span class="metadata-label">Review Status</span>
          <span class="metadata-value">
            {% if invitation.interviewer_review_status == 'completed' %}
              <span class="status-badge status-reviewed">Reviewed</span>
            {% else %}
              <span class="status-badge status-pending">Pending Review</span>
            {% endif %}
          </span>
        </div>
        {% if invitation.completed_at %}
          <div class="metadata-item">
            <span class="metadata-label">Completed At</span>
            <span class="metadata-value">{{ invitation.completed_at|date:"M d, Y g:i A" }}</span>
          </div>
        {% endif %}
      </div>
    </div>
    <!-- Interview Transcript -->
    <div class="review-section">
      <h2>Interview Transcript</h2>
      {% if chat.messages %}
        <div class="chat-messages">
          {% for message in chat.messages %}
            {% if message.role != 'system' %}
              <div class="message message-{{ message.role }}">
                <div class="message-role">{{ message.role|title }}</div>
                <div class="message-content">{{ message.content }}</div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <p style="color: var(--text-secondary);">No messages available.</p>
      {% endif %}
    </div>
    <!-- Interviewer Feedback Form -->
    <div class="review-section">
      <h2>Interviewer Feedback</h2>
      {% if invitation.interviewer_feedback %}
        <div class="existing-feedback">
          <h4>Current Feedback:</h4>
          <p>{{ invitation.interviewer_feedback }}</p>
        </div>
      {% endif %}
      <form method="post" class="feedback-form">
        {% csrf_token %}
        <div class="form-group">
          <label class="form-label" for="interviewer_feedback">
            Your Feedback
            {% if not invitation.interviewer_feedback %}<span style="color: var(--error);">*</span>{% endif %}
          </label>
          <textarea class="form-control"
                    id="interviewer_feedback"
                    name="interviewer_feedback"
                    placeholder="Provide your feedback on the candidate's interview performance..."
                    {% if invitation.interviewer_review_status == 'completed' %}disabled{% endif %}>{{ invitation.interviewer_feedback }}</textarea>
        </div>
        <div class="action-buttons">
          <a href="{% url 'invitation_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
          {% if chat.is_finalized %}
            <a href="{% url 'export_report' chat.id %}"
               class="btn btn-secondary"
               target="_blank">ðŸ“„ View AI Report</a>
          {% endif %}
          {% if invitation.interviewer_review_status != 'completed' %}
            <button type="submit"
                    name="mark_reviewed"
                    value="false"
                    class="btn btn-primary">Save Feedback</button>
            <button type="submit"
                    name="mark_reviewed"
                    value="true"
                    class="btn btn-success">Mark as Reviewed & Notify Candidate</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
{% endblock content %}
