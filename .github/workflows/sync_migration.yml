name: Auto-fix Django Migrations

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  fix-migrations:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Check if migration sync needed
        id: check
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # Check if there are migration changes in this PR
          MIGRATION_CHANGES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep 'migrations/.*\.py$' || true)
          
          if [ -z "$MIGRATION_CHANGES" ]; then
            echo "needs_sync=false" >> $GITHUB_OUTPUT
            echo "No migration changes in this PR"
          else
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            echo "Migration changes detected: $MIGRATION_CHANGES"
          fi
      
      - name: Sync migrations with main and regenerate
        if: steps.check.outputs.needs_sync == 'true'
        run: |
          # Find all Django apps with migrations (specific to active_interview_app)
          MIGRATION_DIRS="./active_interview_backend/active_interview_app/migrations"
          
          echo "Found migration directories:"
          echo "$MIGRATION_DIRS"
          
          # For each migrations directory
          for dir in $MIGRATION_DIRS; do
            echo "================================================"
            echo "Processing: $dir"
            
            # Keep __init__.py if it exists
            if [ -f "$dir/__init__.py" ]; then
              cp "$dir/__init__.py" "/tmp/__init__.py.backup"
            fi
            
            # Remove all Python files in migrations
            rm -f "$dir"/*.py
            
            # Restore __init__.py
            if [ -f "/tmp/__init__.py.backup" ]; then
              mv "/tmp/__init__.py.backup" "$dir/__init__.py"
            else
              touch "$dir/__init__.py"
            fi
            
            # Checkout migrations from main (this will restore all migration files from main)
            git checkout origin/${{ github.base_ref }} -- "$dir" 2>/dev/null || echo "No existing migrations in main for $dir"
          done
          
          echo "================================================"
          echo "Current migrations (from main):"
          find . -path "*/migrations/*.py" ! -name "__init__.py" | sort
          
          echo "================================================"
          echo "Running makemigrations to create new migrations..."
          python3 manage.py makemigrations
          
          echo "================================================"
          echo "All migrations after regeneration:"
          find . -path "*/migrations/*.py" ! -name "__init__.py" | sort
      
      - name: Commit and push if changes exist
        if: steps.check.outputs.needs_sync == 'true'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "django-migration-bot"
            git config user.email "bot@yourdomain.com"
            
            git add .
            
            git commit -m "ðŸ”§ Auto-fix: Sync migrations with main and regenerate

            Changes made by migration bot:
            - Removed all migrations from this branch
            - Restored migrations from main branch  
            - Generated new migrations on top of main's history

            This ensures:
            âœ… Sequential migration numbering
            âœ… Correct migration dependencies
            âœ… No conflicts with main branch"
                        
                        git push
                        
                        echo "::notice::Migrations have been automatically regenerated on top of main"
                    else
                        echo "::notice::No migration changes needed"
                    fi