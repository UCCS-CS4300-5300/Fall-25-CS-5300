# Bandit Security Scanning
# Comprehensive security scanning with SARIF upload to GitHub Security tab
# Combines scheduled scans, manual triggers, and automatic issue creation

name: Bandit Security Scan

on:
  push:
    branches: ["main"]
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - 'active_interview_backend/requirements.txt'
      - '.bandit'
  pull_request:
    branches: ["main"]
  schedule:
    # Run weekly on Tuesdays at 22:44 UTC (original schedule from main)
    - cron: '44 22 * * 2'
  workflow_dispatch: # Allow manual triggers

permissions:
  contents: read
  security-events: write # Required for SARIF upload
  issues: write # Required for creating issues
  actions: read # Required for workflow status

env:
  PYTHON_VERSION: '3.12'

jobs:
  bandit-scan:
    name: Bandit Code Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Security Tools
      run: |
        pip install --upgrade pip
        pip install -r active_interview_backend/requirements.txt
        pip install bandit[sarif] safety

    - name: Run Safety Check (Dependency Vulnerabilities)
      id: safety_scan
      continue-on-error: true
      run: |
        # Generate reports first (don't fail on report generation)
        safety check --output safety-report.txt || true
        safety check --json --output safety-report.json || true
        safety check --full-report --output safety-full-report.txt || true

        # Run actual check that can fail the build
        echo "Running Safety check..."
        if safety check; then
          echo "‚úÖ No dependency vulnerabilities found"
          echo "status=pass" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Dependency vulnerabilities detected"
          echo "status=fail" >> $GITHUB_OUTPUT
        fi

    - name: Run Bandit Scan (Code Security)
      id: bandit_scan
      continue-on-error: true
      run: |
        # Generate SARIF first
        bandit -r . \
          --configfile .bandit \
          -f sarif \
          -o bandit-results.sarif \
          --severity-level medium \
          --confidence-level medium || true

    - name: Validate SARIF Output
      id: validate_sarif
      run: |
        if [ -f bandit-results.sarif ]; then
          FILE_SIZE=$(wc -c < bandit-results.sarif)
          echo "File size: ${FILE_SIZE} bytes"

          # Check if file is not empty (> 100 bytes for minimal SARIF)
          if [ "${FILE_SIZE}" -gt 100 ]; then
            if python -m json.tool bandit-results.sarif > /dev/null 2>&1; then
              echo "‚úÖ Valid SARIF JSON"
              echo "valid=true" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è Invalid SARIF JSON - skipping upload"
              echo "valid=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è SARIF file is empty or too small - skipping upload"
            echo "valid=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "‚ö†Ô∏è SARIF file not found - skipping upload"
          echo "valid=false" >> $GITHUB_OUTPUT
        fi

    - name: Upload SARIF to GitHub Security
      if: steps.validate_sarif.outputs.valid == 'true'
      uses: github/codeql-action/upload-sarif@v4
      continue-on-error: true
      with:
        sarif_file: bandit-results.sarif
        category: bandit
        wait-for-processing: true

    - name: Generate Human-Readable Reports
      id: bandit_analysis
      run: |
        # JSON format
        bandit -r . --configfile .bandit -f json -o bandit-report.json || true

        # Text format
        bandit -r . --configfile .bandit -f txt -o bandit-report.txt || true

        # Check for high severity issues
        if [ -f bandit-report.txt ]; then
          HIGH_COUNT=$(grep -c "Severity: High" bandit-report.txt 2>/dev/null || echo "0")
          HIGH_COUNT=$(echo "$HIGH_COUNT" | tr -d '\n\r' | grep -o '[0-9]*' || echo "0")

          echo "high_count=${HIGH_COUNT}" >> $GITHUB_OUTPUT

          if [ "${HIGH_COUNT}" -gt 0 ]; then
            echo "‚ùå Found ${HIGH_COUNT} high severity security issue(s)"
            echo "status=fail" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No high severity security issues found"
            echo "status=pass" >> $GITHUB_OUTPUT
          fi
        else
          echo "high_count=0" >> $GITHUB_OUTPUT
          echo "status=pass" >> $GITHUB_OUTPUT
        fi

    - name: Display Security Report Summary
      if: always()
      run: |
        {
          echo '# Security Scan Results'
          echo ''
          echo '## 1. Dependency Vulnerabilities (Safety)'
          echo '```'
          cat safety-report.txt || echo "No dependency vulnerabilities found"
          echo '```'
          echo ''
          echo '## 2. Code Security Issues (Bandit)'
          echo ''
          echo '### Scan Configuration'
          echo '- **Severity Level:** Medium and above'
          echo '- **Confidence Level:** Medium and above'
          echo '- **Config File:** .bandit'
          echo ''
          echo '### Results'
          echo '```'
          cat bandit-report.txt || echo "No code security issues found"
          echo '```'
          echo ''
          echo '## View Detailed Results'
          echo '- [Security Tab](https://github.com/${{ github.repository }}/security/code-scanning?query=tool:bandit)'
          echo '- **Artifacts Available:**'
          echo '  - Bandit: bandit-report.json, bandit-report.txt, bandit-results.sarif'
          echo '  - Safety: safety-report.json, safety-report.txt, safety-full-report.txt'
        } >> $GITHUB_STEP_SUMMARY

    - name: Check for Critical Issues
      id: check_critical
      run: |
        if [ -f bandit-report.txt ]; then
          # Count high severity issues (grep -c returns 0 if no matches)
          HIGH_COUNT=$(grep -c "Severity: High" bandit-report.txt 2>/dev/null || echo "0")
          # Clean the count to ensure it's a number
          HIGH_COUNT=$(echo "$HIGH_COUNT" | tr -d '\n\r' | grep -o '[0-9]*' || echo "0")

          echo "high_count=${HIGH_COUNT}" >> $GITHUB_OUTPUT

          if [ "${HIGH_COUNT}" -gt 0 ] 2>/dev/null; then
            echo "found_critical=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Found ${HIGH_COUNT} high severity security issues"
          else
            echo "found_critical=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No high severity security issues found"
          fi
        else
          echo "high_count=0" >> $GITHUB_OUTPUT
          echo "found_critical=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è No bandit report found"
        fi

    - name: Create GitHub Issue for Critical Findings
      if: steps.check_critical.outputs.found_critical == 'true' && github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('bandit-report.txt', 'utf8');

          // Extract high severity issues
          const lines = report.split('\n');
          let highIssues = [];
          let currentIssue = [];
          let inHighIssue = false;

          for (const line of lines) {
            if (line.includes('Severity: High')) {
              inHighIssue = true;
              currentIssue = [line];
            } else if (inHighIssue) {
              if (line.trim() === '' || line.startsWith('---')) {
                highIssues.push(currentIssue.join('\n'));
                currentIssue = [];
                inHighIssue = false;
              } else {
                currentIssue.push(line);
              }
            }
          }

          const highCount = '${{ steps.check_critical.outputs.high_count }}';

          const issueBody = `## üö® Security Scan Alert

          Bandit has detected **${highCount} high severity** security issue(s) in the codebase.

          ### Scan Details
          - **Date:** ${new Date().toISOString().split('T')[0]}
          - **Workflow Run:** [View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **SARIF Report:** Available in [Security Tab](https://github.com/${{ github.repository }}/security/code-scanning?query=tool:bandit)

          ### High Severity Issues
          \`\`\`
          ${highIssues.slice(0, 5).join('\n\n---\n\n')}
          ${highIssues.length > 5 ? '\n\n... and ' + (highIssues.length - 5) + ' more' : ''}
          \`\`\`

          ### Action Required
          1. Review findings in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning?query=tool:bandit)
          2. Prioritize high severity issues
          3. Create fix tasks or dismiss false positives

          ### Resources
          - [Bandit Documentation](https://bandit.readthedocs.io/)
          - [Bandit Quick Reference](https://github.com/${{ github.repository }}/blob/main/docs/setup/bandit-quick-reference.md)
          - [Security Best Practices](https://docs.djangoproject.com/en/stable/topics/security/)

          ---
          *This issue was automatically created by the scheduled security scan workflow.*`;

          // Check if there's already an open issue
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security,automated',
            per_page: 10
          });

          const hasOpenSecurityIssue = existingIssues.data.some(issue =>
            issue.title.includes('Bandit Security Scan Alert')
          );

          if (!hasOpenSecurityIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Bandit Security Scan Alert - ${highCount} High Severity Issue(s) Found`,
              body: issueBody,
              labels: ['security', 'automated', 'bandit']
            });
            console.log('Created new security issue');
          } else {
            console.log('Open security issue already exists, skipping creation');
          }

    - name: Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-reports
        path: |
          bandit-results.sarif
          bandit-report.json
          bandit-report.txt
          safety-report.txt
          safety-report.json
          safety-full-report.txt
        retention-days: 90

    - name: Fail Pipeline on Security Issues
      if: always()
      run: |
        SAFETY_STATUS="${{ steps.safety_scan.outputs.status }}"
        BANDIT_STATUS="${{ steps.bandit_analysis.outputs.status }}"
        HIGH_COUNT="${{ steps.bandit_analysis.outputs.high_count }}"

        echo "Security Scan Results:"
        echo "  - Safety (dependencies): ${SAFETY_STATUS:-unknown}"
        echo "  - Bandit (code): ${BANDIT_STATUS:-unknown}"
        echo "  - High severity issues: ${HIGH_COUNT:-0}"

        if [ "$SAFETY_STATUS" = "fail" ] || [ "$BANDIT_STATUS" = "fail" ]; then
          echo ""
          echo "‚ùå Security scan failed - blocking pipeline"
          echo ""
          if [ "$SAFETY_STATUS" = "fail" ]; then
            echo "‚ö†Ô∏è Dependency vulnerabilities found - review safety-report.txt"
          fi
          if [ "$BANDIT_STATUS" = "fail" ]; then
            echo "‚ö†Ô∏è ${HIGH_COUNT} high severity code security issue(s) found - review bandit-report.txt"
          fi
          echo ""
          echo "Action required:"
          echo "1. Review security reports in artifacts"
          echo "2. Check GitHub Security tab for details"
          echo "3. Fix critical security issues"
          echo "4. Re-run the workflow"
          exit 1
        else
          echo ""
          echo "‚úÖ All security scans passed"
        fi
