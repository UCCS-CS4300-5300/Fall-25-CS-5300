# Architecture Overview

Active Interview Service is a Django web application that provides AI-powered interview practice.

## High-Level Architecture

```
┌──────────────┐
│    User      │
│  (Browser)   │
└──────┬───────┘
       │ HTTP
       v
┌──────────────┐       ┌──────────────┐
│    Nginx     │       │   OpenAI     │
│ (Prod only)  │       │  GPT-4o API  │
└──────┬───────┘       └──────▲───────┘
       │                      │
       v                      │
┌──────────────┐              │
│   Gunicorn   │              │
│  (3 workers) │              │
└──────┬───────┘              │
       │                      │
       v                      │
┌──────────────┐              │
│    Django    │──────────────┘
│  Application │
└──────┬───────┘
       │
       v
┌──────────────┐
│   Database   │
│ SQLite / PG  │
└──────────────┘
```

## Technology Stack

### Backend
- **Django 4.2.19** - Web framework
- **Gunicorn 23.0.0** - WSGI server (production)
- **Django REST Framework 3.15.2** - REST API
- **OpenAI GPT-4o** - AI interview generation

### Database
- **SQLite** - Development
- **PostgreSQL** - Production (Railway)

### Frontend
- **Bootstrap 5** - UI framework
- **jQuery** - DOM manipulation
- **Ajax** - Async communication
- **DOMPurify** - XSS protection

### File Processing
- **PyMuPDF** - PDF parsing
- **python-docx** - DOCX parsing
- **ReportLab** - PDF generation
- **Pillow** - Image processing

### Testing
- **Django TestCase** - Unit tests
- **Selenium** - E2E tests
- **Coverage.py** - Code coverage
- **Behave** - BDD testing (optional)

### Deployment
- **Docker** - Containerization
- **Docker Compose** - Multi-container orchestration
- **Nginx** - Reverse proxy, static files (production)
- **Railway** - Hosting platform
- **GitHub Actions** - CI/CD

---

## Project Structure

```
Fall-25-CS-5300/
│
├── active_interview_backend/      # Django project
│   ├── active_interview_project/  # Django settings
│   │   ├── settings.py           # Configuration
│   │   ├── urls.py               # Root URL config
│   │   └── wsgi.py               # WSGI entry point
│   │
│   ├── active_interview_app/      # Main application
│   │   ├── models.py             # Data models
│   │   ├── views.py              # View logic (~900 lines)
│   │   ├── urls.py               # App URL patterns
│   │   ├── forms.py              # Django forms
│   │   ├── serializers.py        # DRF serializers
│   │   ├── pdf_export.py         # PDF generation
│   │   ├── templates/            # HTML templates
│   │   ├── static/               # CSS, JS, images
│   │   └── tests/                # Test suite
│   │
│   ├── features/                  # BDD feature files (Gherkin)
│   ├── db/                        # SQLite database
│   ├── media/                     # User uploads
│   ├── staticfiles/              # Collected static files
│   ├── manage.py                 # Django CLI
│   └── requirements.txt          # Python dependencies
│
├── docs/                          # Documentation
│   ├── setup/                    # Setup guides
│   ├── deployment/               # Deployment docs
│   ├── architecture/             # Architecture docs
│   └── features/                 # Feature specs
│
├── .github/workflows/            # CI/CD pipelines
│   ├── CI.yml                    # Continuous Integration
│   └── CD.yml                    # Continuous Deployment
│
├── scripts/                       # Utility scripts
│   ├── check-coverage.sh         # Coverage validation
│   └── clean-restart.sh          # Clean environment
│
├── nginx.local.conf              # Nginx config (development)
├── nginx.prod.conf               # Nginx config (production)
├── docker-compose.yml            # Development containers
├── docker-compose.prod.yml       # Production containers
├── Dockerfile                    # Django container image
├── README.md                     # Project overview
└── AGENTS.md                     # Claude Code guidance
```

---

## Application Flow

### User Registration & Authentication

```
User → /accounts/register/ → CreateUserForm → User created
     └─> Assigned to "average_role" group
     └─> Redirect to login

User → /accounts/login/ → Django Auth → Session created
     └─> Redirect to profile
```

### Interview Session Creation

```
User → /chat/create/ → CreateChatForm
  │
  ├─> Select resume (optional)
  ├─> Select job listing (optional)
  ├─> Set difficulty (1-10)
  └─> Choose interview type:
      ├─ General Interview
      ├─ Industry Skills
      ├─ Personality/Culture Fit
      └─ Final Screening

      ↓
Chat created with:
  ├─ System prompt (generated from resume/job/type/difficulty)
  ├─ 10 key timed questions (generated by OpenAI)
  └─ Empty messages array []

      ↓
User redirected to /chat/<id>/
```

### Active Interview Session

```
User → /chat/<id>/ → ChatView
  │
  ├─> Display: Chat history (messages)
  ├─> Display: Key questions sidebar
  │
  └─> User types message → POST /chat/<id>/
      │
      ├─> Append user message to chat.messages
      ├─> Send to OpenAI GPT-4o with system prompt
      ├─> Receive AI response
      ├─> Append assistant message to chat.messages
      ├─> Save chat
      └─> Return JSON response
      │
      └─> JavaScript updates UI with AI response
```

### Results & Report Generation

```
User completes interview → /chat/<id>/results/
  │
  ├─> Display: Feedback from AI
  ├─> Display: Performance charts
  │
  └─> User clicks "Generate Report"
      │
      ↓
POST /chat/<id>/generate-report/
  │
  ├─> Parse AI feedback from messages
  ├─> Extract scores (professionalism, knowledge, clarity)
  ├─> Build question-response array
  ├─> Create ExportableReport model
  ├─> Save to database
  │
  └─> Redirect to /chat/<id>/export-report/
      │
      ├─> Display: Formatted report in browser
      │
      └─> User clicks "Download PDF"
          │
          └─> GET /chat/<id>/download-pdf/
              ├─> Generate PDF with ReportLab
              └─> Return FileResponse (PDF download)
```

---

## Key Components

### Models

See [Models Documentation](models.md) for detailed model reference.

**Core Models:**
- `User` - Django built-in (extended with groups)
- `UploadedResume` - User resume files
- `UploadedJobListing` - Job posting documents
- `Chat` - Interview session container
- `ExportableReport` - Generated interview reports

**Tracking Models:**
- `TokenUsage` - OpenAI API usage tracking
- `MergeTokenStats` - Git merge statistics

### Views

**Class-Based Views:**
- Authentication mixins (`LoginRequiredMixin`, `UserPassesTestMixin`)
- Generic views (`ListView`, `DetailView`, `CreateView`, etc.)

**Key Views:**
- `ChatView` - Active interview (GET + POST for messages)
- `CreateChat` - Interview setup
- `ResultsChatView` - Post-interview feedback
- `GenerateReportView` - Report creation
- `UploadFileView` - Resume/job listing uploads

### OpenAI Integration

**Location:** `active_interview_app/views.py`

**Client initialization:**
```python
from openai import OpenAI
client = OpenAI(api_key=settings.OPENAI_API_KEY)
```

**System prompt generation:**
- Dynamically created based on:
  - Resume content (if uploaded)
  - Job listing (if uploaded)
  - Interview type (General/Skills/Personality/Final)
  - Difficulty level (1-10)

**API usage:**
- Model: GPT-4o
- Max tokens: 15,000
- Generates: Interview questions, responses, feedback, scores

### File Processing

**Supported formats:**
- PDF (via PyMuPDF)
- DOCX (via python-docx)

**Validation:**
- File type detection (via `filetype` library)
- Size limits (Django settings)

**Storage:**
- Uploaded files: `media/uploads/`
- Text content: Extracted and stored in model fields

---

## Security Features

### Authentication & Authorization

- Django's built-in authentication system
- Session-based auth (cookies)
- Login required for most views (`LoginRequiredMixin`)
- Ownership validation (`UserPassesTestMixin`)
- Group-based permissions (`average_role`)

### CSRF Protection

- Enabled by default in Django
- CSRF tokens required for POST requests
- Trusted origins configured in settings

### Input Validation

- Form validation (Django forms)
- DRF serializer validation
- File type validation
- XSS protection (DOMPurify on frontend)

### Environment Variables

- Secrets stored in environment (not code)
- `.env` file for Docker (gitignored)
- GitHub secrets for CI/CD

---

## Database Schema

See [Models Documentation](models.md) for detailed schema.

**Key relationships:**
```
User ──┬─< UploadedResume
       ├─< UploadedJobListing
       ├─< Chat
       └─< ExportableReport (via Chat)

Chat ──┬─< ExportableReport (OneToOne)
       ├─> UploadedResume (optional ForeignKey)
       └─> UploadedJobListing (optional ForeignKey)
```

---

## API Endpoints

See [API Documentation](api.md) for detailed API reference.

**REST API:**
- `/api/resumes/` - Resume CRUD
- `/api/job-listings/` - Job listing CRUD
- Authentication required (IsAuthenticated)

---

## Static Files

### Development

Django serves static files automatically via `runserver`.

### Production

**Collection:**
```bash
python manage.py collectstatic --noinput
```

**Serving:**
- WhiteNoise middleware (Django)
- Nginx (reverse proxy, caching)

**Locations:**
- Source: `active_interview_app/static/`
- Collected: `staticfiles/`
- Media: `media/` (user uploads)

---

## Environment Modes

### Development (`PROD=false`)

- DEBUG = True
- SQLite database
- Django serves static files
- Auto-generated secret key (insecure)
- Detailed error pages

### Production (`PROD=true`)

- DEBUG = False
- PostgreSQL database (Railway)
- WhiteNoise + Nginx serve static files
- Required secret key from environment
- Generic error pages
- Gunicorn WSGI server

---

## Performance Considerations

### OpenAI API Calls

- Expensive (cost + latency)
- Mocked in tests to avoid unnecessary API usage
- Rate limits apply (OpenAI account tier)

### Database

- SQLite suitable for development
- PostgreSQL for production (better concurrency)
- Indexes on frequently queried fields

### Caching

- Browser caching via Nginx headers
- WhiteNoise caching for static files
- Consider Django cache framework for future optimization

---

## Deployment Architecture

### Development

```
┌─────────────┐
│   Django    │
│  runserver  │
│   :8000     │
└─────────────┘
```

### Production (Railway)

```
┌──────────┐      ┌───────────┐      ┌──────────┐
│  Railway │      │ Gunicorn  │      │PostgreSQL│
│  Router  │─────>│ 3 workers │─────>│ Database │
│   :443   │      │   :8000   │      │          │
└──────────┘      └───────────┘      └──────────┘
                        │
                        v
                  ┌──────────┐
                  │WhiteNoise│
                  │ Static   │
                  └──────────┘
```

### Docker Compose (Local/CI)

```
┌─────────┐      ┌─────────┐      ┌──────────┐
│  Nginx  │─────>│ Django  │─────>│ SQLite   │
│   :80   │      │Gunicorn │      │   db/    │
└─────────┘      └─────────┘      └──────────┘
                      │
                      v
                ┌──────────┐
                │  Chrome  │
                │Chromedriver│ (for E2E tests)
                └──────────┘
```

---

## Next Steps

- **[Models Reference](models.md)** - Detailed model documentation
- **[API Reference](api.md)** - REST API endpoints
- **[Features](../features/)** - User-facing feature specs
